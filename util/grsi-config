#!/usr/bin/env bash 

readlink=readlink
if [ `uname` = "AIX" ]; then
  readlink=echo
fi

# work around readlink versions not having -f option
fullpath1=`$readlink $0`
if [ "$?" -ne "0" ]; then
  fullpath1=$0
else
  if [ ${fullpath1##/} = $fullpath1 ] && [ ${fullpath1##~} = $fullpath1 ]; then
    # relative path, prepend directory where executable was found
    lpath=`dirname $0`
    fullpath1=$lpath/$fullpath1
  fi
fi

progdir=`dirname $fullpath1`
runningdir=`pwd`
if [ ${progdir##/} != $progdir ] || [ ${progdir##~} != $progdir ]; then
  # absolute path
  fullpath=$progdir
else
  # relative path
  if [ $progdir != "." ]; then
    fullpath=$runningdir/$progdir
  else
    fullpath=$runningdir
  fi
fi

# work around readlink versions not having -f option
fullpath1=`$readlink $fullpath`
if [ "$?" -ne "0" ]; then
  fullpath1=$fullpath
fi


libdir=$GRSISYS/lib
incdir=$GRSISYS/include

# the repitition of '-lTGRSIint -lTFormat' is needed for debian-style OSes like ubuntu (see issue #979)
grsilibs="-lTDetector -lTGRSIint -lTFormat -lTGRSIint -lTFormat -lTLoops -lTKinematics -lTSRIM -lTBetaDecay -lTCal -lTReaction"
detlibs="-lTSuppressed -lTBgo -lTPulseAnalyzer -lGROOT -lTGRSIFit -lTNucleus"
grsimore="-lTRawFile -lTDataParser -lTHistogramming"

cflags="-std=c++11 -I$incdir"

usage="\
Usage: grsi-config [--version] [--incdir] [--cflags] [--libs] [--all-libs] [--<detector specific library>-libs/incdir/cflags] [--help]"

if test $# -eq 0; then
  echo "${usage}" 1>&2
  exit 1
fi

out=""

incdirout=no
cflagsout=no
libsout=no
alllibsout=no
rootout=no

while test $# -gt 0; do
  case "$1" in 
  -*=*) optarg=`echo "$1" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
  *)    optarg= ;;
  esac

  case $1 in
    --version)
      ### Output the version number.  If GVersion.h can not be found, give up.
      if test -r ${incdir}/GVersion.h; then
        out="$out `sed -n 's,.*GRSI_RELEASE *\"\(.*\)\".*,\1,p' < ${incdir}/GVersion.h`"
      else
        echo "cannot read ${incdir}/GVersion.h"
        exit 1
      fi
      ;;
    --incdir)
      if test "x$incdirout" = "xyes" ; then
        shift
        continue
      fi
      incdirout="yes"
      out="$out $incdir "
      ;;
    --cflags)
      if test "x$cflagsout" = "xyes" ; then
        shift
        continue
      fi
      cflagsout="yes"
      out="$out $cflags "
      ;;
    --libs)
      if test "x$libsout" = "xyes" ; then
        shift
        continue
      fi
      libsout="yes"
      if test "x$alllibsout" = "xyes" ; then
        shift
        continue
      fi
      out=$"$out -L${libdir} $grsilibs $detlibs "
      ;;
    --all-libs)
      if test "x$alllibsout" = "xyes" ; then
        shift
        continue
      fi
      alllibsout="yes"
      if test "x$libsout" = "xyes" ; then
        out=$"$out $grsimore "
      else
        out=$"$out -L${libdir} $grsilibs $detlibs $grsimore -lXMLParser -lXMLIO -lX11 -lXpm -lProof -lGuiHtml -lMinuit -lSpectrum -lMathMore "
      fi
      ;;
	 --*-cflags)
		 lib=${1%-cflags}; # remove trailing -cflags
		 lib=${lib#--};  # remove leading  --
		 # check that the config script exists
		 if [ -e $GRSISYS/$lib/util/config ] ; then
			 out="$out `$GRSISYS/$lib/util/config --cflags`"
		 fi
		 ;;
	 --*-incdir)
		 lib=${1%-incdir}; # remove trailing -incdir
		 lib=${lib#--};  # remove leading  --
		 # check that the config script exists
		 if [ -e $GRSISYS/$lib/util/config ] ; then
			 out="$out `$GRSISYS/$lib/util/config --incdir`"
		 fi
		 ;;
	 --*-libs)
		 lib=${1%-libs}; # remove trailing -libs
		 lib=${lib#--};  # remove leading  --
		 # check that the config script exists
		 if [ -e $GRSISYS/$lib/util/config ] ; then
			 out="$out `$GRSISYS/$lib/util/config --libs`"
		 fi
		 ;;
    --root)
      if test "x$rootout" = "xyes" ; then
        shift
        continue
      fi
      rootout="yes"
      out="$out `root-config --cflags --libs` -lPhysics -lSpectrum" 
      ;;
    --help)
      ### Print a helpful message...
      echo "Usage: `basename $0` [options]"
      echo ""
      echo "  --version       Print the current GRSI Version number."
      echo "  --incdir        Print header path."
      echo "  --cflags        Print compiler flags and header path."
      echo "  --libs          Print libdir + most used GRSI libraries."
      echo "  --all-libs      Print libdir + all GRSI libraries."
		echo "  --<det>-libs    Print libdir for detector specific libraries."
      echo "  --root          Print root-config output need for most grsi compulations."
      echo "  --help          Print what you see here."
      exit 0
      ;;
    *)
      ### Give an error
      echo "Unknown argument \"$1\"!" 1>&2
      echo "${usage}" 1>&2
      exit 1
      ;;
   esac
   shift 
done

echo $out

